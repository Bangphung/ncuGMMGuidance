%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Input Variables
% M     = Moment Magnitude
% T     = Period (sec); Use Period = -1 for PGV computation
%                 Use 1000 for output the array of Sa with original period
%                 (no interpolation)
% Rrup   = Closest distance (km) to the ruptured plane
% eqt    =  type of event
%        = 0 interface
%        = 1 intra slab
% flag       = 0 for Japan+Taiwan
%            = 1 for Taiwan
% Vs30          = shear wave velocity averaged over top 30 m in m/s

% Output Variables
% Sa: Median spectral acceleration prediction
% sigma: logarithmic standard deviation of spectral acceleration
%          prediction
% tau
% phi
function [Sa,sigma] = PhungSDZ_GMPE_July_2019c(T,M,Ztor,Rrup,Vs30,Z10,flag,eqt)
period = [0 0.01 0.02  0.05  0.075  0.1  0.15  0.20  0.25  0.3  0.4  0.5  0.6  0.75  ... 
         1  1.5  2  2.5  3  4  5];
% ip = find(period==T);
% Sa = PLC_SDZ17_sub(M,Ztor,Rrup,Vs30,ip,reg);
NT=length(T);
Sa=zeros(1,NT);
sigma=zeros(1,NT);
tau=zeros(1,NT);

for I=1:1:NT
    T_low = max(period(period <= T(I)));
    T_high = min(period(period >= T(I)));
    ip_low  = find(period==T_low);
    ip_high = find(period==T_high);
    if ( ip_low == ip_high )
        [Sa(I),tau(I),sigma(I)]= PLC_SDZ17_sub(M,Ztor,Rrup,Vs30,Z10,ip_low,flag,eqt);     
    else
        [Sa_low,tau_low,sigma_low] = PLC_SDZ17_sub(M,Ztor,Rrup,Vs30,Z10,ip_low,flag,eqt);
        [Sa_high,tau_high,sigma_high] = PLC_SDZ17_sub(M,Ztor,Rrup,Vs30,Z10,ip_high,flag,eqt);
        
        x = [log(T_low) log(T_high)];
        Y_sa = [log(Sa_low) log(Sa_high)];        
        Y_sigma = [sigma_low sigma_high];
        Y_tau = [tau_low tau_high];
       
        
        Sa(I) = exp(interp1(x, Y_sa, log(T(I))));
        sigma(I) = interp1(x, Y_sigma, log(T(I)));
        tau(I) = interp1(x, Y_tau, log(T(I)));
       
            
    end
end

function [Sa,tau,sigma] = PLC_SDZ17_sub(M,Ztor,Rrup,Vs30,Z10,ip,flag,eqt) 
%% Period-independent coefficients
c4 = 10;
a3 = 0.10; 
a9 = 0.25;
n = 1.18;
c = 1.88; 
Vlin	= [865.1	865.1	865.1	1053.5	1085.7	1032.5	877.6	748.2	654.3	587.1	503	456.6	430.3	410.5	400	400	400	400	400	400	400];
b	= [-1.186	-1.186	-1.186	-1.346	-1.471	-1.624	-1.931	-2.188	-2.381	-2.518	-2.657	-2.669	-2.599	-2.401	-1.955	-1.025	-0.299	0	0	0	0];
%%
a5 = [0.03849929	0.04033665	0.04190178	0.04509359	0.04623140	0.04819708	0.04325090	0.03692059	0.06597319	0.06197944	0.06979644	0.08783791	0.09612877	0.10612877	0.22744484	0.16136621	0.22767232	0.27153377	0.28822087	0.32589322	0.30383949];
a13 = [-0.0256568	-0.0259617	-0.0262528	-0.0270426	-0.0276048	-0.0280794	-0.0287650	-0.0291017	-0.0290970	-0.0287552	-0.0269993	-0.0235859	-0.0180673	-0.0150673	-0.0031849	-0.0031849	-0.0031849	-0.0031849	-0.0031849	-0.0031849	-0.0031849];
Mref = [7.68	7.68	7.68	7.71	7.77	7.77	7.78	7.72	7.62	7.54	7.42	7.38	7.36	7.32	7.25	7.25	7.25	7.25	7.25	7.25	7.25];   
a2  = [-1.552846733	-1.554174269	-1.555152194	-1.556049687	-1.554562252	-1.551165488	-1.539140832	-1.520764226	-1.489051706	-1.464118878	-1.414761429	-1.383170353	-1.360022278	-1.313716982	-1.236841977	-1.100570482	-0.990254902	-0.896093506	-0.818199517	-0.730697376	-0.734817372];
a14 = [-0.011876681	-0.012409284	-0.016872732	-0.08510905	-0.118005772	-0.171218187	-0.124720279	-0.120958201	-0.116255248	-0.077408811	-0.054966213	-0.034173086	-0.06069315	-0.039053473	0.017806808	-0.005705423	0.053155037	0.068765677	0.071577687	0.042405486	0.054712361];
%% TW+JP 
del_a1 = [1.141899742	1.152006702	1.154339185	1.515303155	1.904431142	1.945456526	1.787100626	1.562515125	1.356740101	1.206013896	0.760110718	0.431629072	0.214072689	-0.01782956	-0.204991951	-0.382378342	-0.352611734	-0.228719047	-0.16534756	0.010400184	0.135306871];
del_a4	=  [0.328613796	0.352192886	0.367677006	0.452541112	0.513739193	0.499522237	0.45427803	0.363869484	0.314270529	0.282854636	0.176621233	0.077343234	0.044354701	-0.012346815	-0.083175191	-0.226959428	-0.206168741	-0.163340854	-0.154799226	-0.112793712	-0.003105582];

a6_jp = [-0.006794362	-0.006817094	-0.006816137	-0.007285287	-0.007702243	-0.007674043	-0.00782682	-0.007547403	-0.007323965	-0.006976346	-0.006143907	-0.005504091	-0.004739568	-0.004285202	-0.003957479	-0.003379651	-0.003469497	-0.003409644	-0.003614492	-0.003749858	-0.003243671];
a8_jp = [-0.0075	-0.0083	-0.0083	-0.0212	-0.0278	-0.0308	-0.0193	-0.0087	-0.0062	-0.0045	0.0240	0.0488	0.0640	0.0720	0.0791	0.0864	0.0905	0.0976	0.0987	0.0890	0.0758];
%%
tau0	= [0.426469333	0.424670673	0.429099403	0.477262493	0.516365961	0.512863781	0.461620132	0.441284014	0.434871493	0.417105574	0.412231943	0.396422531	0.403512982	0.409058414	0.428087961	0.440164103	0.451402135	0.461009777	0.457681279	0.470193371	0.461834624];
phiss_tj = [0.420489356	0.420220542	0.418935068	0.419356601	0.41012804	0.420066336	0.433030041	0.446059203	0.456165064	0.459407794	0.452177558	0.443446716	0.4378372	0.446095737	0.44128784	0.42093392	0.425797447	0.419978946	0.413207757	0.36936182	0.349936999];
phis2s_tj = [0.364038777	0.364065617	0.364403496	0.417921293	0.469674634	0.469076147	0.437340846	0.397161802	0.384511586	0.373773022	0.372643333	0.369406327	0.397812841	0.419424271	0.408446403	0.420315802	0.416797894	0.404296599	0.362727332	0.354026172	0.300771328];
%% TW_Specific
a1	= [4.46422	4.48194	4.50464	4.62523	4.79044	4.92617	5.09496	5.18110	5.13520	5.07746	4.91507	4.79323	4.66100	4.40139	3.74331	2.82226	1.88325	1.01478	0.41174	-0.51990	-0.92355];
a4	= [0.441987425	0.442328411	0.436082809	0.363261281	0.319469336	0.325896968	0.350561168	0.401101385	0.440779304	0.486141867	0.593885499	0.719248494	0.848115514	0.96522535	1.174894012	1.360979471	1.38307024	1.382803719	1.391730855	1.36799257	1.379913313];
a7 = [0.681875399	0.679916748	0.697566565	1.036117503	1.229932174	1.534436374	1.263659339	1.177341019	1.046187707	0.783076472	0.56945524	0.437054838	0.497762038	0.262897537	-0.126754198	-0.121313834	-0.496676074	-0.513466165	-0.600511124	-0.425097306	-0.545699974+0.0171];
a6 = [-0.000639314	-0.000607826	-0.000577165	-0.000490096	-0.00042309	-0.000361045	-0.000251542	-0.000161014	-8.90E-05	-3.54E-05	1.45E-05	-4.21E-05	-7.26E-05	-0.000119483	-0.000199116	-0.000362196	-0.000611716	-0.000869846	-0.00106641	-0.001185004	-0.0009885];

Si12tw = [0.99033	0.99037	0.99282	1.31918	1.50198	1.63759	1.89340	2.08726	2.23477	2.34640	2.48809	2.50062	2.40243	2.07480	1.48948	0.38514	-0.41535	-0.75365	-0.73641	-0.69136	-0.70127];
Si12jp = [0.94642	0.94648	0.95388	1.31215	1.49926	1.61904	1.77120	1.87989	1.95713	2.03887	2.24946	2.29652	2.23798	2.05421	1.55696	0.57387	-0.26271	-0.63003	-0.54192	-0.49677	-0.42910];

a8	= [-0.06276	-0.06296	-0.06325	-0.08865	-0.09405	-0.09783	-0.08546	-0.07070	-0.06045	-0.05366	-0.01430	0.02962	0.06271	0.08935	0.12475	0.16430	0.17542	0.16991	0.16367	0.15060	0.15646];
a10	= [0.016025291	0.017193978	0.01828222	0.020842842	0.022162011	0.022757257	0.021797461	0.020180594	0.018556649	0.016978648	0.014555899	0.012627818	0.011191399	0.009211979	0.006851124	0.003814084	0.001733925	0	0	0	0];
a11 = [0.014951807	0.014930723	0.01491224	0.01487185	0.014854753	0.014852358	0.014893477	0.015004213	0.015194298	0.01540766	0.015952307	0.016437613	0.01652538	0.016212382	0.015784785	0.01399451	0.011927777	0.009749305	0.007785629	0.00494863	0.003408571];

tau_tw = [0.352252822	0.349216437	0.344782755	0.355375576	0.380828528	0.388526115	0.368100637	0.368643954	0.375291842	0.365828808	0.383635154	0.378521294	0.369787955	0.375567859	0.375762655	0.39959416	0.411391314	0.428877733	0.432913094	0.435941037	0.415321618];
phiss_tw = [0.4130	0.4126	0.4113	0.4095	0.4003	0.4094	0.4280	0.4438	0.4503	0.4532	0.4428	0.4383	0.4426	0.4556	0.4518	0.4305	0.4413	0.4379	0.4302	0.4268	0.4286];
phis2s_tw = [0.3443	0.3441	0.3434	0.3907	0.4405	0.4499	0.4104	0.3782	0.3559	0.3460	0.3546	0.3589	0.3812	0.3856	0.3692	0.3703	0.3713	0.3578	0.3500	0.3234	0.3040];
%% Regional term
if flag ==0
   a1 = a1(ip) + del_a1(ip);
   a4 = a4(ip) + del_a4(ip);
   
   a6 = a6_jp(ip);
   a12 = Si12jp(ip);

   tau = tau0(ip);
   phi_SS = phiss_tj(ip);
   phi_S2S = phis2s_tj(ip);
else
   a1 = a1(ip);
   a4 = a4(ip);
   a6 = a6(ip);
   a12 = Si12tw(ip);
 
   tau = tau_tw(ip);
   phi_SS = phiss_tw(ip);
   phi_S2S = phis2s_tw(ip);
end
%% Magnitude Scaling
if M <= Mref(ip)
   fmag =  a4*(M - Mref(ip)) + a13(ip)*(10-M)^2;
else
   fmag =  a5(ip)*(M - Mref(ip)) + a13(ip)*(10-M)^2;
end  
%% FZtor
if eqt ==0 
   f_ztor = a10(ip)*(min(Ztor,40)-20);
else
   f_ztor = a11(ip)*(min(Ztor,80)-40); 
end
%% Path Scaling
X = a1 + a7(ip)*(eqt==1) + (a2(ip) + a14(ip)*(eqt==1) + a3*(M -7.8))*log(Rrup + c4*exp(a9*(M-6)))+ a6*Rrup;
%% Site Effect
  PGA1000 = ph18c_PGA_r(M, Rrup, 1000, Ztor, eqt, flag);  
 
%%
Vs30 = min(Vs30,1000);
% Nonlinear component
if ( Vs30< Vlin(ip) )
    fsite = a12*log(Vs30/Vlin(ip)) - b(ip)*log(PGA1000+c)+b(ip)*log(PGA1000+c*(Vs30/Vlin(ip))^n);
else
    fsite = a12*log(Vs30/Vlin(ip)) + b(ip)*n*log(Vs30/Vlin(ip));
end%% Basin Depth term

if flag == 1
    Ez_1 = exp(-3.96/2*log((Vs30^2+352.7^2)/(1750^2+352.7^2)));   
   if Z10 == -999 
      f_z10 = 0;
   else   
      f_z10 = a8(ip)*(min(log(Z10./Ez_1),1));
   end 
else
   Ez_1 = exp(-5.23/2*log((Vs30.^2 + 412.39^2)/(1360^2 + 412.39^2)));
   if Z10 == -999 
      f_z10 = 0;
   else   
      f_z10 = a8_jp(ip)*(min(log(Z10./Ez_1),1));
   end
end
%%
Sa = exp(fmag + X  + f_ztor + fsite + f_z10);
sigma = sqrt(tau.^2+  phi_SS.^2 + phi_S2S.^2);
