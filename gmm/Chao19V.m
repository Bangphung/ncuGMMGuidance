function [Sa,tau,phis2s,phiss]=Chao19V(T,M,Rrup,Ztor,Vs30,Z10,FRO,FSS,FNO,Finter,Fintra,Fas,Fma,FVS30)

% Input definition and size
% T: period nt x 1
% M: Magnitude nr x 1
% Rrup: Distance in km unit nr x 1
% Ztor: depth to top of rupture plane in km unit (-999 as default) nr x 1
% Vs30: Vs30 in m/sec unit nr x 1
% Z1.0: depth to Vs30 == 1000 m/s in m unit (-999 as default) nr x 1
% FRO: flag for the R/RO fault of crustal earthquake (0/1) nr x 1
% FSS: flag for the SS fault of crustal earthquake event (0/1) nr x 1
% FNO: flag for the N/NO fault of crustal earthquake event (0/1) nr x 1
% Finter: flag for the interface earthquake (0/1) nr x 1
% Fintra: flag for the intraslab earthquake (0/1) nr x 1
% Fas: flag for the aftershock (0/1) nr x 1
% Fma: flag for the Manila Subduction (0/1) nr x 1
% FVS30: flag for the source of Vs30 (0 for Kuo17 (measured), 1 for KS17
% (inferred), 2 for Receiver Function (inferred)) 1 x 1
%
% Output
% Sa: spectral acceleration in unit g nr x nt
% tau: between event std. in ln(g) unit nr x nt
% phis2s: between site std. in ln(g) unit nr x nt
% phiss: single station std. in ln(g) unit nr x nt

period=[0;0.01;0.02;0.03;0.05;0.075;0.1;0.15;0.2;0.25;0.3;0.4;0.5;0.75;1;1.5;2;3;4;5;-1;-2];

NR=max([length(M) length(Rrup)]);
NT=length(T);
Sa=zeros(NR,NT);
tau=zeros(NR,NT);
phis2s=zeros(NR,NT);
phiss=zeros(NR,NT);

for I=1:1:NT

    T_low = max(period(period <= T(I)));
    T_high = min(period(period >= T(I)));
    ip_low  = find(period==T_low);
    ip_high = find(period==T_high);
    if ( ip_low == ip_high )
        [Sa(:,I),tau(:,I),phis2s(:,I),phiss(:,I)]=Chao19V_sub(ip_low,M,Rrup,Ztor,Vs30,Z10,FRO,FSS,FNO,Finter,Fintra,Fas,Fma,FVS30);     
    else
        [Sa_low,tau_low,phis2s_low,phiss_low] = Chao19V_sub(ip_low,M,Rrup,Ztor,Vs30,Z10,FRO,FSS,FNO,Finter,Fintra,Fas,Fma,FVS30);
        [Sa_high,tau_high,phis2s_high,phiss_high] = Chao19V_sub(ip_high,M,Rrup,Ztor,Vs30,Z10,FRO,FSS,FNO,Finter,Fintra,Fas,Fma,FVS30);
        
        x = [log(T_low) log(T_high)]';
        Y_sa = [log(Sa_low) log(Sa_high)]';        
        Y_tau = [tau_low tau_high]';
        Y_phis2s = [phis2s_low phis2s_high]';
        Y_phiss = [phiss_low phiss_high]';
        
        Sa(:,I) = exp(interp1(x, Y_sa, log(T(I))))';
        tau(:,I) = interp1(x, Y_tau, log(T(I)))';
        phis2s(:,I) = interp1(x, Y_phis2s, log(T(I)))';
        phiss(:,I) = interp1(x, Y_phiss, log(T(I)))';
        
    end
end

function [median,tau,phis2s,phiss]=Chao19V_sub(iT,M,Rrup,Ztor,Vs30,Z10,FRO,FSS,FNO,Finter,Fintra,Fas,Fma,FVS30)

par=[...
-0.9813544036886240 	-1.0275861933948600 	-1.0251536198106700 	-1.5185479689828200 	-0.4631812754690720 	-0.1133068837459890 	0.2550338144077780 	0.4818002891176240 	0.4180197896964810 	-0.1052128893159860 	-0.0000000964586660 	-0.0000000543735484 	-0.0000001383936251 	0.0338846577890871 	0.0238248184633552 	0.0105363859903819 	-1.3982830825393900 	-1.2861847798941500 	0.3361512343022940 	0.2523152790644470 	-0.0032582756629475 	-0.0053643456339715 	-2.6245716939769700 	-0.3181113650858480 	0.0583161695949224 	-0.6583866342882760 	-0.7227211585680920 	-0.7070451822957280 	-0.2873676707188630 	-0.2873676707188630 ;...
-0.9782580921174180 	-1.0205023175534100 	-1.0169254197589200 	-1.5779947932537000 	-0.5178442919034140 	-0.1131497438340680 	0.2474793952934480 	0.4901911143260630 	0.3994504929391900 	-0.1015248206368130 	-0.0000020123398307 	-0.0000009785947384 	-0.0000025281086587 	0.0339651459285065 	0.0227043619629340 	0.0108782708735788 	-1.4023927027616300 	-1.2048858797157200 	0.3239606173128060 	0.2533428198558510 	-0.0030739117079174 	-0.0061770045783048 	-2.4162376557986500 	-0.3098259678915430 	0.0592976262092791 	-0.6566567959991710 	-0.7216703152102920 	-0.7074474423500610 	-0.2528376614184180 	-0.2528376614184180 ;...
-0.9174542346816710 	-0.9513907267226670 	-0.9400183299377720 	-1.5695470562072900 	-0.4487506783520500 	-0.1107528996165060 	0.2321154280343050 	0.4235235880813920 	0.3370137956598810 	-0.1048453200367630 	-0.0000020230062906 	-0.0000010430336448 	-0.0000027133575315 	0.0360216104670688 	0.0233747014130040 	0.0117150725984695 	-1.4838444243943900 	-1.2058871654181700 	0.3578108646138230 	0.2900633377060950 	-0.0027580362458129 	-0.0067613584402603 	-2.0195874839737000 	-0.3137103494699080 	0.0699656438865923 	-0.5655554908020690 	-0.6340895936673470 	-0.6231446038179230 	-0.1863031992827410 	-0.1863031992827410 ;...
-0.8309608085249230 	-0.8516369129770010 	-0.8222296763270480 	-1.4506980472302600 	-0.2339136918514790 	-0.1072962697774420 	0.2105417369251390 	0.4049322752934870 	0.3144295666323060 	-0.1008507774584780 	-0.0000016463446447 	-0.0000008368262661 	-0.0000021983309631 	0.0387502598321481 	0.0242626124645655 	0.0123692408691574 	-1.5527423506171800 	-1.2665249044140800 	0.3722254725968940 	0.3051141004052800 	-0.0029770229303770 	-0.0070341273320219 	-1.6665742701553900 	-0.3223924450448580 	0.0819938221451028 	-0.4602335580955440 	-0.5322510674374900 	-0.5252502405729770 	-0.1737743290573410 	-0.1737743290573410 ;...
-0.6366447133081360 	-0.6356695544926810 	-0.5858640965217190 	-1.1143708722152700 	0.2233027236281770 	-0.1062022868354120 	0.2050525718475770 	0.4688576089442480 	0.3836642085094320 	-0.0871972030828643 	-0.0000010666391230 	-0.0000004445423596 	-0.0000011689682526 	0.0421033431096578 	0.0253583661650161 	0.0126776315395760 	-1.6052597235770600 	-1.4224216672412100 	0.3480839602531630 	0.2706580875928720 	-0.0040028022186999 	-0.0067633306139145 	-1.3480385054880100 	-0.3432900042368420 	0.0942902553960270 	-0.3341760524807920 	-0.4141970205717700 	-0.4059071926300730 	-0.2782026127465860 	-0.2782026127465860 ;...
-0.4789941298627540 	-0.4665596821808590 	-0.4117567502294970 	-0.7707638232887490 	0.5799690245439990 	-0.1149727162544260 	0.2238532492991230 	0.5697527131422920 	0.5340878588612830 	-0.0813398464402145 	-0.0000006948481005 	-0.0000002080737441 	-0.0000004846011995 	0.0423393894740351 	0.0251063474208087 	0.0118120118234868 	-1.5549051358007100 	-1.5546048450585000 	0.2996883274697450 	0.1928119506253020 	-0.0052397626073563 	-0.0058050661262216 	-1.4114752104993400 	-0.3676459051473290 	0.0931944292424922 	-0.3133208793376540 	-0.4058904908245200 	-0.3839529241122250 	-0.4438880792461120 	-0.4438880792461120 ;...
-0.3987978247214150 	-0.3854151003300340 	-0.3428143062000720 	-0.5819467945938470 	0.7083281491752730 	-0.1219415932145020 	0.2683681123828000 	0.6339874300024670 	0.6657752293695910 	-0.0899046036129318 	-0.0000006899602529 	-0.0166689452069020 	-0.0000006776880375 	0.0403005815287012 	0.0244598090082152 	0.0107802926161659 	-1.4700314421319300 	-1.5944158250928800 	0.2601379752976730 	0.1338580031021300 	-0.0059649177296873 	-0.0050425121197987 	-1.6164758330610000 	-0.3902359571800850 	0.0852249423335719 	-0.3648447034908180 	-0.4675626405505310 	-0.4282592102859170 	-0.5632684176738730 	-0.5632684176738730 ;...
-0.3528378580372090 	-0.3639444804818680 	-0.3411898922978400 	-0.5126345448632440 	0.6113825843597160 	-0.1250274981816650 	0.3647427191799100 	0.6759655323729320 	0.7818154908342610 	-0.1293468880415980 	-0.0009789222993075 	-0.1263613654490650 	-0.0278678439713981 	0.0345610205918156 	0.0240306295323917 	0.0092191599285897 	-1.3204939501464400 	-1.5219788315912500 	0.2153277002090240 	0.0903875777482547 	-0.0062392938566773 	-0.0043677370795892 	-1.8411900293343700 	-0.4063344106430380 	0.0665002296852325 	-0.5103791374999550 	-0.6126232923813120 	-0.5540452681523540 	-0.6180067458532770 	-0.6180067458532770 ;...
-0.3685667554557680 	-0.4089701060905760 	-0.4147385078904840 	-0.5776853473206090 	0.3862313268835210 	-0.1183132276455440 	0.4114345916565860 	0.6884595464737060 	0.7879462134952970 	-0.1684880695147230 	-0.0227596074685871 	-0.1964575438846730 	-0.1089139990372020 	0.0290787218685560 	0.0239804144914309 	0.0080823203367576 	-1.2186730342794600 	-1.4153470411607400 	0.1909989056831380 	0.0906584190667614 	-0.0058009185240884 	-0.0039806656634922 	-1.7518823931792000 	-0.3798028851224540 	0.0496817695012104 	-0.6368586389437660 	-0.7215926435803980 	-0.6644516130533360 	-0.5616392622805670 	-0.5616392622805670 ;...
-0.3916809293481490 	-0.4635023137219860 	-0.5010673772656540 	-0.6632855873645440 	0.1612117278012250 	-0.1087093727425810 	0.4162593624524900 	0.7004040618562640 	0.7757111530019220 	-0.1971913300682970 	-0.0608186630888561 	-0.2641257022540670 	-0.1796158825567050 	0.0243513711306761 	0.0236818664207655 	0.0071722498298653 	-1.1535609536762100 	-1.3173709900345200 	0.1770286565540570 	0.1026220132674910 	-0.0051652212665106 	-0.0037622621752158 	-1.5707456515140800 	-0.3356628555426340 	0.0374915071744680 	-0.7345865367030510 	-0.7980149282321880 	-0.7566093806058320 	-0.4968155567345480 	-0.4968155567345480 ;...
-0.4202251398627370 	-0.5203957107582250 	-0.5915300208427940 	-0.7614172256559020 	-0.0715755469449492 	-0.0982287876917177 	0.4105555175664930 	0.7124183023397290 	0.7465821074518500 	-0.2184444001219290 	-0.1040555423450200 	-0.3469462363574810 	-0.2356952017471190 	0.0203880981304165 	0.0229386921399565 	0.0063695205508458 	-1.1067633846861900 	-1.2282802503304400 	0.1698894163461920 	0.1235389296852940 	-0.0045628113151329 	-0.0036139195684625 	-1.3888409307781100 	-0.2914876661337730 	0.0292276885718146 	-0.8148751245710120 	-0.8584324739105410 	-0.8398382200567170 	-0.4230224145278890 	-0.4230224145278890 ;...
-0.4820612675405350 	-0.6228897677256520 	-0.7458060651037870 	-0.8904121728510380 	-0.3985539840747950 	-0.0867489696427221 	0.3469472581104690 	0.7423608431269420 	0.6915865533773800 	-0.2456388054461530 	-0.1908070684465500 	-0.4146667305085310 	-0.3517375379413000 	0.0147784089307184 	0.0215191034226957 	0.0049064786010488 	-1.0480523338891100 	-1.1336513640891800 	0.1699840114216760 	0.1569536122320240 	-0.0036367683517406 	-0.0030777772559091 	-1.1219240522286300 	-0.2264270419100280 	0.0210782880408509 	-0.9325920052910800 	-0.9516565630297650 	-0.9762662087485230 	-0.3106726230051010 	-0.3106726230051010 ;...
-0.5276910796644010 	-0.6978263115570680 	-0.8531834327552990 	-0.9597795811839550 	-0.6163862247902510 	-0.0831162563621963 	0.2781303655795150 	0.7809577612533530 	0.6742349121342320 	-0.2603121524085040 	-0.2611321033287160 	-0.4418555805227660 	-0.4483252511978240 	0.0106935763526277 	0.0199916075054116 	0.0037323857518235 	-1.0139499442097100 	-1.0904844794918200 	0.1762937731004490 	0.1742087327187240 	-0.0030151166975045 	-0.0025937300332193 	-1.0553889306333400 	-0.1963898068258800 	0.0196869843032869 	-1.0277750820981600 	-1.0346247225131600 	-1.0952374691902100 	-0.2602129502675440 	-0.2602129502675440 ;...
-0.6039593057402960 	-0.8163586391718070 	-1.0055270627844700 	-1.1305041713303800 	-1.0355738680583000 	-0.0885379024523824 	0.1943505532464450 	0.8777577674481820 	0.6586799721403980 	-0.2925855482578660 	-0.3026566771687390 	-0.4567036511648150 	-0.6479360544926300 	0.0045419208129572 	0.0171893741434786 	0.0019509807242804 	-0.9688625802948560 	-1.0271934899545200 	0.1913021589884470 	0.1972467596164880 	-0.0022630090828538 	-0.0018905553219128 	-1.2030482350699000 	-0.2219576497002220 	0.0313352843171134 	-1.2446640447070300 	-1.2411823368319400 	-1.3559173653374600 	-0.1996402690989680 	-0.1996402690989680 ;...
-0.6791095104041500 	-0.9045516436039980 	-1.0935278240104800 	-1.2948150242566500 	-1.3111696833222100 	-0.0986872660027844 	0.1396926428444680 	0.9682725159821600 	0.6365005337039510 	-0.3227569221891320 	-0.2604347942824270 	-0.3734174579870210 	-0.8396395517544630 	0.0016047516105861 	0.0161817114583777 	0.0010319756786848 	-0.9455518985160570 	-1.0037215081985900 	0.2008827318336590 	0.2057932060586800 	-0.0019972802596759 	-0.0013592137475234 	-1.2503517803932100 	-0.2975347222731820 	0.0484823679307419 	-1.4260109337410700 	-1.4152127240764900 	-1.5523890355712800 	-0.1586309220856620 	-0.1586309220856620 ;...
-0.8573388017682620 	-1.0670786126735800 	-1.2523667670839200 	-1.6143771732551600 	-1.7759551382857400 	-0.1034300247742050 	0.1204519010437820 	1.1230618901615700 	0.6447073369570420 	-0.3635294442969400 	-0.1339313232888710 	-0.2343778346691670 	-1.0526178935250200 	-0.0017751281122486 	0.0128000887362734 	0.0001273312193331 	-0.9255902516564840 	-0.9525633600130300 	0.1998898447808890 	0.2099745807022900 	-0.0018107278045616 	-0.0010259427265895 	-0.8788941343103730 	-0.4625329830031500 	0.0762572352140188 	-1.6912876469234000 	-1.6591325192587600 	-1.8148365895888400 	-0.1486710486505440 	-0.1486710486505440 ;...
-1.0786043490020200 	-1.2595578961928600 	-1.4276728112866200 	-1.9630597572716300 	-2.1981401715795900 	-0.0891072988035154 	0.0949251022227249 	1.2532324583414900 	0.6566013109096350 	-0.3783648553908150 	-0.0586725748245706 	-0.1379988863489370 	-1.1109354183272200 	-0.0036603248746770 	0.0086994950591185 	-0.0002616316147250 	-0.9278212387954530 	-0.8690032226486730 	0.1929960403575720 	0.2319687790279860 	-0.0017139347401069 	-0.0013250445854175 	-0.5188021538341310 	-0.5417926222678950 	0.0915995838348221 	-1.8167380591078200 	-1.7628244185413000 	-1.9341512786169600 	-0.1437225885251140 	-0.1437225885251140 ;...
-1.5585798718146300 	-1.7007209918292300 	-1.8361780244334000 	-2.6344150795546200 	-2.9753822910785900 	-0.0386226153810607 	0.1063645304531860 	1.4329043661941300 	0.6642560389919700 	-0.3718234913410780 	-0.0026382471425533 	-0.0499125182657213 	-1.0990581007831700 	-0.0081298761518281 	0.0014947254754843 	-0.0004922763336960 	-0.9346414734376540 	-0.7316204459678220 	0.1837621427370310 	0.2769140050883400 	-0.0016668927104333 	-0.0022568386114620 	-0.0315812862914954 	-0.6050635537443110 	0.0972186176431447 	-1.8701799432152900 	-1.7868553819450500 	-1.9759607403606900 	-0.1193547563644910 	-0.1193547563644910 ;...
-2.0016475847027800 	-2.1287980798286300 	-2.2270161480883700 	-3.2722598327403700 	-3.6637048557379800 	0.0165436526522607 	0.1045427333770370 	1.5632552318806400 	0.6372688159624970 	-0.3486259462273240 	-0.0000001082862273 	-0.0000003302589164 	-1.0495928530065700 	-0.0124900655548834 	-0.0039746915102614 	-0.0003992903518643 	-0.9424277556562310 	-0.5929782619390700 	0.1807106727627030 	0.3295933431560420 	-0.0016766935445506 	-0.0033769036197597 	0.0000000000000000 	-0.5607946160849520 	0.0903502846718502 	-1.8048330629189300 	-1.7006194555076800 	-1.9073569926255500 	-0.0591954200545808 	-0.0591954200545808 ;...
-2.5677525595386200 	-2.6955888364689500 	-2.7527090323105000 	-3.9970626711103100 	-4.6190544832118300 	0.1421488993450080 	0.2561453349002960 	1.6833328664455900 	0.4723021548898760 	-0.3018029720935880 	-0.0000002699857466 	-0.0000010980673168 	-1.0327993051067600 	-0.0162215213012315 	-0.0085751288256483 	0.0010941663497574 	-0.8860254612321700 	-0.5012270775614320 	0.1714579514707360 	0.3972645622663310 	-0.0022551574689743 	-0.0039689052045237 	0.0000000000000000 	-0.5307198265220240 	0.0733664770794062 	-1.6684726394773400 	-1.5580506382285900 	-1.7474943325871800 	0.1315595714661290 	0.1315595714661290 ;...
2.3684232270006900 	2.0023102344662900 	1.7326312854795000 	-1.5679067885901000 	-1.7333016477140200 	0.0022613150745113 	1.9957736238373100 	0.5868534743137530 	0.0000000249428150 	-0.1813694533533800 	-0.0000003743906838 	-1.9608591262068300 	-0.0000000346914645 	-0.0114036322922327 	0.0794512079682951 	0.0177984283654493 	-1.0699268525310200 	-1.1848773198654000 	0.2120340773694710 	-0.0328824945326875 	-0.0012470190671365 	-0.0055853806268631 	-1.6694820026450500 	-0.2897466614798020 	0.0343273815906019 	-0.0965163996992895 	-0.0963908097332095 	-0.1636369863265360 	-0.0000000137233461 	-0.0000000137233461 ;...
1.7956796080088200 	1.5402939467969200 	1.6006471905384600 	-1.8619524092266400 	-2.0462095054758400 	-0.2226456519789870 	1.0375026669379200 	1.5001362830929700 	0.0975424730806403 	-0.1078301469200390 	-0.0000001844002907 	-1.4916987486476200 	-0.0909666672118616 	-0.0145802930453624 	0.0608416353711455 	0.0183884130947833 	-0.7810159160026880 	-0.8205857819531780 	0.1297789175956910 	0.0222153372427582 	-0.0034152958876785 	-0.0079634440554377 	0.0000000000000000 	-0.4336086338503910 	0.0603808873964760 	-0.7076084722435090 	-0.6914138644536200 	-0.7194744621745930 	-0.0975424308154526 	-0.0975424308154526 ];...

par1=[...
0.3403086838205990 	0.3139521175623100 	0.2938174457557560 	0.5983405953368390 	0.4843398393665470 	0.4091811962195550 	0.4476536754374440 	0.4782053035861500 	0.3545368189741800 ;...
0.3327748702747980 	0.3145769571011370 	0.2823849117907620 	0.6210477455426930 	0.4797845601941120 	0.4104808865401440 	0.4471681245704330 	0.4907528482792740 	0.3514171328091300 ;...
0.3544226054119130 	0.3266062654563770 	0.2954385654048300 	0.6474799407394190 	0.4870284626349730 	0.4316749822912870 	0.4491058520293260 	0.5072880677624750 	0.3742491085334750 ;...
0.3641265186355780 	0.3480257019238670 	0.3209493698608910 	0.6632855998353110 	0.4885806951087660 	0.4486905985962830 	0.4509669604572520 	0.5212797957436660 	0.4082221667766940 ;...
0.3594275554234850 	0.3862047481087280 	0.3511411860546410 	0.6659642795655290 	0.4831525293101830 	0.4556349072265900 	0.4506026141221190 	0.5350602143146510 	0.4540642345398760 ;...
0.3581847123005770 	0.3985904212224070 	0.3612327731835200 	0.6313142545371470 	0.4846123988111820 	0.4385801063799940 	0.4494622124140180 	0.5327597345936100 	0.4637122793277020 ;...
0.3675605314930650 	0.3870660792006440 	0.3561981412670000 	0.5912352887817310 	0.4958105603502960 	0.4196522079786070 	0.4511264523271950 	0.5232927365961930 	0.4527333579130120 ;...
0.4007996062536070 	0.3383794532776160 	0.3598388599402860 	0.5336040177649530 	0.5199402244248990 	0.3991234637529830 	0.4609440021297870 	0.5005035888732370 	0.4262531424521870 ;...
0.4333639962084150 	0.2964629124678530 	0.3707864755122470 	0.5072203985753130 	0.5370940880744990 	0.3933616749749720 	0.4703840450474320 	0.4792580805556120 	0.4086422787307560 ;...
0.4610200101707080 	0.2710879173941080 	0.3877069920606900 	0.4940246953585640 	0.5456493412221000 	0.3948074091949920 	0.4756603561772710 	0.4633252070012270 	0.3955621452779360 ;...
0.4835039466213710 	0.2581484553493650 	0.4129640634270150 	0.4942726230800810 	0.5498046200543870 	0.4000803789951380 	0.4758098976957290 	0.4546898124504880 	0.3840251408286850 ;...
0.5141642970062210 	0.2605484307623490 	0.4455613946194860 	0.5086627324221540 	0.5528948029084210 	0.4125176717420350 	0.4727231026984140 	0.4492577003460990 	0.3670346499418280 ;...
0.5351680429399560 	0.2825725072172040 	0.4648122398454300 	0.5255144967488520 	0.5514611901240810 	0.4251306346121260 	0.4682745683899620 	0.4532099722843300 	0.3552955864256410 ;...
0.5609633993868570 	0.3466452556741430 	0.4792218145365000 	0.5909730122556960 	0.5429638963054520 	0.4517413998408460 	0.4620074406140950 	0.4729038169607780 	0.3398230179108930 ;...
0.5678859566898210 	0.3925185332333200 	0.4382799488930930 	0.6689378716741730 	0.5367344566068250 	0.4700944515494190 	0.4627711667748730 	0.4862203185181000 	0.3359473992662870 ;...
0.5670631017718340 	0.4405818185460790 	0.3599802274936270 	0.7550025492609890 	0.5252368159112410 	0.4928315954680780 	0.4625228450292010 	0.5032612139134470 	0.3367360232746140 ;...
0.5673280630644470 	0.4579017639134720 	0.2837208088327570 	0.7808991852515390 	0.5151701356303290 	0.5044769223832000 	0.4597405796620010 	0.5120469591787250 	0.3416198103202750 ;...
0.5755922844657600 	0.4765401611248300 	0.2185506198043750 	0.7298446689311330 	0.4874426607338270 	0.5113111997558460 	0.4527545560675690 	0.5183149727775850 	0.3563603317029770 ;...
0.5979299079785000 	0.4873711829583840 	0.1902083705361890 	0.6519233426850810 	0.4598780196130310 	0.5090347547254570 	0.4488825692816330 	0.5135481822531070 	0.3732493171152380 ;...
0.6081088903840670 	0.4724785330803750 	0.2357417563834490 	0.6002648561465400 	0.4200557905089820 	0.4976545218389850 	0.4425559816533880 	0.4947901329370130 	0.3865118301946630 ;...
0.6775438816563900 	0.9999999913647760 	0.9999999976063720 	0.9999999964796290 	0.4536114771865490 	0.4355513720789070 	0.4552013426471480 	0.5223547191916260 	0.2356682766305860 ;...
0.7311045249288560 	0.9999999822362940 	0.9999999510270600 	0.9999999917253690 	0.7942102985490580 	0.5315839699452150 	0.6509315660415610 	0.6944596769739440 	0.2511347635018860 ];


C4inter=0.2;
C4intra=0.2;
Mc=7.1;
Mref=6.5;
n=2;
Vs30ref=760;
Rrupref=0;

Z10ref=exp(-4.08/2*log( (Vs30.^2+355.4^2)/(1750^2+355.4^2) ));
Hcrref=0;
Hinterref=0;
Hintraref=35;

Fcr=FRO+FSS+FNO;
Fsb=Finter+Fintra;
if ( Z10 == -999 )
    Z10=Z10ref;
end

h=Fcr*10+Finter*10*exp(C4inter*(M-Mc).*heaviside(M-Mc))+Fintra*10*exp(C4intra*(M-Mc).*heaviside(M-Mc));

if ( FVS30 == 0 )
    Fvs30kuo17=1;Fvs30ks17=0;Fvs30rf=0;
elseif ( FVS30 == 1 )
    Fvs30kuo17=0;Fvs30ks17=1;Fvs30rf=0;
elseif ( FVS30 == 2 )
    Fvs30kuo17=0;Fvs30ks17=0;Fvs30rf=1;
else
    Fvs30kuo17=1;Fvs30ks17=0;Fvs30rf=0;
    disp('FVS30 Input Error ! Use Vs30 from Kuo17')
end

NR=size(M,1);
Xt=zeros(NR,30);

Xt(:,1)=FRO;
Xt(:,2)=FSS;
Xt(:,3)=FNO;
Xt(:,4)=Finter;
Xt(:,5)=Fintra;
Xt(:,6)=Fas;
Xt(:,7)=Fma;
Xt(:,8)=Fcr.*(M-Mref);
Xt(:,9)=Fsb.*(M-Mref);
Xt(:,10)=Fcr.*(M-Mref).^2-Fcr.*(M-7.6).^2.*heaviside(M-7.6);
Xt(:,11)=Fcr.*(5-M).*heaviside(5-M);
Xt(:,12)=Fsb.*(5-M).*heaviside(5-M);
Xt(:,13)=Fsb.*(6-M).*heaviside(6-M);
Xt(:,14)=Fcr.*(Ztor-Hcrref);
Xt(:,15)=Finter.*(Ztor-Hinterref);
Xt(:,16)=Fintra.*(Ztor-Hintraref);
Xt(:,17)=Fcr.*log((Rrup.^n+h.^n).^(1/n) ./ (Rrupref.^n+h.^n).^(1/n) );
Xt(:,18)=Fsb.*log((Rrup.^n+h.^n).^(1/n) ./ (Rrupref.^n+h.^n).^(1/n) );
Xt(:,19)=Fcr.*(          M-Mref).*log((Rrup.^n+h.^n).^(1/n) ./ (Rrupref.^n+h.^n).^(1/n) );
Xt(:,20)=Fsb.*(min(M,Mc  )-Mref).*log((Rrup.^n+h.^n).^(1/n) ./ (Rrupref.^n+h.^n).^(1/n) );
Xt(:,21)=Fcr.*(Rrup-Rrupref);
Xt(:,22)=Fsb.*(Rrup-Rrupref);
Xt(:,23)=0;
Xt(:,24)=log(1180/Vs30ref);
Xt(:,25)=0;%log(Z10/Z10ref);
Xt(:,26)=Fvs30kuo17;
Xt(:,27)=Fvs30ks17;
Xt(:,28)=Fvs30rf;

Xt(:,29)=Finter.*(M-Mc).*heaviside(M-Mc);
Xt(:,30)=Fintra.*(M-Mc).*heaviside(M-Mc);

Sa1180=exp(Xt*par(iT,:)');

% Change c value for PGV prediction
if ( iT > 20 )
    c=2400;
else
    c=2.4;
end
Xt(:,23)=(-1.5*log(Vs30./Vs30ref)-log(Sa1180+c)+log(Sa1180+c*(Vs30./Vs30ref).^1.5)).*heaviside(Vs30ref-Vs30);
Xt(:,24)=log(Vs30./Vs30ref);
Xt(:,25)=log(Z10./Z10ref);

median=exp(Xt*par(iT,:)');

fM=0.5*(min(6.5,max(4.5,M))-4.5);
tau=Fcr .* ( par1(iT,1)+(par1(iT,2)-par1(iT,1))*fM )...
   +Fsb .* ( par1(iT,3)+(par1(iT,4)-par1(iT,3))*fM );
phiss=Fcr .* ( par1(iT,5)+(par1(iT,6)-par1(iT,5))*fM )...
   +Fsb .* ( par1(iT,7)+(par1(iT,8)-par1(iT,7))*fM );
phis2s=par1(iT,9)*ones(NR,1);

