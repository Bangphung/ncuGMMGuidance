%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Input Variables
% M     = Moment Magnitude
% T     = Period (sec); 
%              
% Rrup   = Closest distance (km) to the ruptured plane
% Rjb   = Joyner-Boore distance (km); closest distance (km) to surface
%       projection of rupture plane
% Rx    =    Horizontal distance from top of rupture measured perpendicular 
%       to fault strike (km). See Figures a, b and c for illustation% Ztor  = Depth(km) to the top of ruptured plane
% delta = Fault dip angle (in degree)
% lamda = Rake angle      (in degree)
% region        = 1 for Taiwan
%               = 2 for California
%               = 4 for Japan
%               = 3 for others 

% Z10            = Basin depth (m); depth from the groundsurface to the
%                   1km/s shear-wave horizon.
%               = -999 if unknown
%               = 'na' if unknow
% Vs30          = shear wave velocity averaged over top 30 m in m/s
%               = ref: 1130
% Ztor          = depth to top of rupture , [km]
%               =-999 if specify average Ztor
% Output Variables
% Sa: Median spectral acceleration prediction
% sigma: logarithmic standard deviation of spectral acceleration
%          prediction based on tau and phi model of CY14 with the change in
%          phi1.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function [Sa, yrefij, sigma_T, sigma_T2] = Phung_2019v_NGAw2_TW(M, T, Rrup, Rjb, Rx, Ztor, delta, Fhw, lambda, Vs30, Z10, rgn, flg_AS)
period = [0 0.01 0.02	0.03  0.04	0.05  0.075  0.1  0.12  0.15  0.17  0.2  0.25 0.30 0.4  0.5 ...
          0.75  1.0   1.5   2  3  4  5  7.5  10];
delta=delta*pi()/180.0;
F_RV = lambda >= 30 & lambda <= 150; % frv: 1 for lambda between 30 and 150, 0 otherwise
F_NM = lambda >= -120 & lambda <= -60; % fnm: 1 for lambda between -120 and -60, 0 otherwise

if Fhw == 1
    HW = 1;
elseif Fhw == 0
    HW = 0;
else
    HW = Rx>=0;
end
d_DPP=0; % for median calculatio, d_DPP=0.
%% 
if length (T) == 1 && T == 1000 % Compute Sa and sigma with pre-defined period
    Sa=zeros(1,length(period));
    yrefij=zeros(1,length(period));

    sigma_T = zeros(1, length(T));
     sigma_T2 = zeros(1, length(T));
    for ip=1:length(period)
        [Sa(ip),yrefij(ip),sigma_T(ip),sigma_T2(ip)]=Phung_2018_sub(M, ip, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
    end
else                            % Compute Sa and sigma with user-defined period
    Sa=zeros(1, length(T));
    yrefij = zeros(1, length(T));
    sigma_T = zeros(1, length(T));
     sigma_T2 = zeros(1, length(T));
    for i=1:length(T)
        Ti = T(i);
        if ( isempty(find(abs(period-Ti) < 0.0001))) % The user defined period requires interpolation
            T_low = max(period(period < Ti));
            T_high = min(period(period > Ti));
            ip_low  = find(period==T_low);
            ip_high = find(period==T_high);
            
            [Sa_low,yrefij_low,sig_low,sig_low2] = Phung_2018_sub(M, ip_low, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
            [Sa_high,yrefij_high,sig_high,sig_high2] = Phung_2018_sub(M, ip_high, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
           
            x = [log(T_low) log(T_high)];
            Y_sa = [log(Sa_low) log(Sa_high)];
            Y_yrefij = [yrefij_low yrefij_high];
            Y_sig = [sig_low sig_high];
             Y_sig2 = [sig_low2 sig_high2];
            
            Sa(i) = exp(interp1(x, Y_sa, log(Ti)));
            yrefij(i) = exp(interp1(x, Y_yrefij, log(T(i))));
            sigma_T(i) = interp1(x, Y_sig, log(T(i)));
            sigma_T2(i) = interp1(x, Y_sig2, log(T(i)));
        else
            ip_T = find(abs((period- Ti)) < 0.0001);
            [Sa(i),yrefij(i), sigma_T(i),sigma_T2(i)] = Phung_2018_sub(M, ip_T, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
        end
    end
end


function [Sa, yrefij,Sig_SS,Sig_T] = Phung_2018_sub(M, ip, R_RUP, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS)
%% period-indipendent fixing coefs
c4 = -2.1;
c4_a = -0.5;
c_RB = 50;
c2 = 1.06; 
%%
c1 = [-1.9098	-1.8714	-1.8083	-1.5895	-1.3503	-1.1723	-0.9336	-0.8672	-0.9081	-1.0195	-1.0765	-1.1460	-1.2102	-1.2513	-1.3720	-1.5530	-2.0378	-2.4355	-2.9265	-3.2361	-3.6878	-3.8785	-3.9702	-4.1148	-4.3956];
c3 = [1.4839	1.4756	1.4622	1.4142	1.4363	1.4449	1.4820	1.5184	1.5271	1.5562	1.5697	1.6091	1.6925	1.7973	1.9466	2.0815	2.3590	2.5594	2.7637	2.8663	2.9934	3.2132	3.2876	3.1862	3.1668];
c_n = [12.1487	12.1487	12.2480	12.5338	12.9919	13.6508	15.7145	16.7726	16.7756	16.1868	15.8431	15.0147	12.6964	10.4498	6.8022	4.4107	3.4064	3.1612	2.8078	2.4631	2.2111	1.9668	1.6671	1.5737	1.5265];
c_m = [5.6286	5.6017	5.5131	5.4959	5.5833	5.6940	5.8822	5.9418	5.9455	5.9285	5.9146	5.8964	5.8741	5.8574	5.8295	5.8072	5.7928	5.8310	5.9619	6.0817	6.2489	6.3799	6.5072	6.7954	6.9848];
%%
c_g1 = [-0.01047	-0.01012	-0.01032	-0.01195	-0.01407	-0.01539	-0.01668	-0.01560	-0.01438	-0.01304	-0.01215	-0.01111	-0.01012	-0.00922	-0.00750	-0.00608	-0.00449	-0.00378	-0.00322	-0.00321	-0.00375	-0.00392	-0.00422	-0.00336	-0.00210];
phi1TW = [-0.3397	-0.3380	-0.3484	-0.3928	-0.4338	-0.4288	-0.4151	-0.3785	-0.3651	-0.3757	-0.3735	-0.3524	-0.3161	-0.2595	-0.1706	-0.1642	-0.2552	-0.3642	-0.5031	-0.5842	-0.6944	-0.7479	-0.7201	-0.5154	-0.4381];
c_g2 = [-0.00815	-0.00963	-0.01118	-0.01417	-0.01337	-0.00971	-0.00290	-0.00125	-0.00084	0.00000	-0.00005	-0.00009	-0.00053	-0.00062	-0.00120	-0.00212	-0.00222	-0.00233	-0.00256	-0.003403369	-0.004301538	-0.000418141	-0.0032388	-0.004339438	-0.012177643];
c_g3	= [4.225634814	4.225634814	4.230341898	4.236182109	4.250188668	4.303122568	4.446126947	4.610835161	4.723496543	4.878140618	4.981707053	5.066410859	5.21986472	5.32821979	5.201761713	5.187931728	4.877209058	4.63975087	4.571203643	4.425116502	3.6219035	3.48626393	3.277906342	3.074948086	3.074948086];
%% Fixed Coefficients    
c5	= [5.5709	5.7382	5.7684	5.7684	5.7684	5.7684	5.7684	5.9668	6.1006	6.3448	6.6077	7.0795	7.9046	8.6311	9.6131	10.0720	10.1901	10.2048	10.2368	10.2847	10.3247	10.3247	10.3247	10.3247	10.3247];
c_HM	= [3.0956	3.0956	3.0963	3.0974	3.0988	3.1011	3.1094	3.2381	3.3407	3.43	3.4688	3.5146	3.5746	3.6232	3.6945	3.7401	3.7941	3.8144	3.8284	3.833	3.8361	3.8361	3.8361	3.8361	3.8361];
c6	= [0.508 0.508	0.508	0.508	0.508	0.508	0.508	0.508	0.508	0.508	0.508	0.508	0.5068	0.505	0.5007	0.4961	0.4846	0.4704	0.4401	0.4264	0.4183  0.4183	0.4183	0.4183	0.4183];
dp	= [-6.785205271	-6.750647967	-6.716179208	-6.681798923	-6.647507037	-6.613303475	-6.52818049	-6.443607867	-6.376345237	-6.276109027	-6.209722535	-6.110797854	-5.947665543	-5.786703295	-5.47125339	-5.164376146	-4.4342041	-3.75596604	-2.55026692	-1.536847647	-0.052837841	0	0	0	0];
%%
c7	= [0.00803536	0.00803536	0.007592927	0.007250488	0.007006048	0.006860143	0.007007726	0.007246641	0.007455965	0.00770271	0.007798775	0.007823121	0.00807121	0.008395901	0.00927498	0.010165826	0.012793392	0.013761922	0.013899933	0.012559337	0.009183764	0.004796976	0.001067909	-0.004234005	-0.006203311];
c7_b = [0.0346375	0.0356235	0.036924	0.03944	0.0388875	0.0357765	0.0299455	0.0302005	0.0296735	0.029699	0.028679	0.0289935	0.028781	0.0285005	0.026724	0.0260015	0.023154	0.0209355	0.015691	0.012206	0.0070635	0.003196	0.0055845	0.0111945	0.0122995];
%%
c1_a	= [0.137929376	0.131008944	0.124713602	0.119040284	0.113983621	0.109535952	0.101016047	0.096066418	0.094563811	0.096331606	0.100411816	0.113754448	0.132878713	0.147312358	0.158162078	0.163112167	0.169389333	0.177254643	0.17612706	0.161185738	0.112720638	0.053953075	0.053953075	0.053953075	0.053953075];
c1_c = [0.12818721	0.16474638	0.19798902	0.227722749	0.25397256	0.277152444	0.328589817	0.33006438	0.304617216	0.243804261	0.198997185	0.141005172	0.056124471	0	0	0	0	0	0	0	0	0	0	0	0];

c1_b = [0	0	0	0	0	0	0	0	0	0	0	0	-0.034932397	-0.052793111	-0.096705093	-0.121161057	-0.158672494	-0.184203622	-0.218917854	-0.218956446	-0.218956446	-0.218956446	-0.218956446	-0.218956446	-0.218956446];
c1_d = [-0.165254064	-0.164615502	-0.166706035	-0.19413385	-0.2133523	-0.246430796	-0.240863766	-0.22991286	-0.171017133	-0.13673324	-0.085084587	-0.078934463	-2.86E-07	0	0	0	0	0	0	0	0	0	0	0	0];

c11	= [-0.108037007	-0.108037007	-0.102071888	-0.104638092	-0.105159212	-0.09694663	-0.079174009	-0.120806584	-0.127655488	-0.123958373	-0.120234904	-0.128554524	-0.104990465	-0.125335213	-0.131458922	-0.102606613	-0.072842909	-0.072286657	-0.143270261	-0.171095562	-0.269171794	-0.321537372	-0.344321787	-0.379466889	-0.478010668];
c11_b = [0.195951708	0.195951708	0.181778172	0.163170085	0.142063237	0.098053885	0.046296818	0.173997245	0.209294889	0.217339629	0.218818569	0.262936287	0.231024464	0.27034386	0.306056087	0.272617073	0.265158493	0.303895403	0.443286099	0.520454201	0.817526599	1.015932218	0.892205391	0.86436398	1.443597529];
%%
c9	= [0.9228	0.9228	0.9296	0.9396	0.9661	0.9794	1.0260	1.0177	1.0008	0.9801	0.9652	0.9459	0.9196	0.8829	0.8302	0.7884	0.6754	0.6196	0.5101	0.3917	0.1244	0.0086	0.0000	0.0000	0.0000];
c9_a	= [0.1202	0.1202	0.1217	0.1194	0.1166	0.1176	0.1171	0.1146	0.1128	0.1106	0.1150	0.1208	0.1208	0.1175	0.1060	0.1061	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000];
c9_b	= [6.8607	6.8607	6.8697	6.9113	7.0271	7.0959	7.3298	7.2588	7.2372	7.2109	7.2491	7.2988	7.3691	6.8789	6.5334	6.5260	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000];

c8	= [0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0991	0.1982	0.2154	0.2154	0.2154	0.2154	0.2154	0.2154	0.2154	0.2154];
c8_a	= [0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695];
c8_b	= [0.4833	0.4833	1.2144	1.6421	1.9456	2.1810	2.6087	2.9122	3.1045	3.3399	3.4719	3.6434	3.8787	4.0711	4.3745	4.6099	5.0376	5.3411	5.7688	6.0723	6.5000	6.8035	7.0389	7.4666	7.7700];
%%
c_g1CA	= [-0.0092	-0.0092	-0.0094	-0.0111	-0.0126	-0.0137	-0.0139	-0.0136	-0.0126	-0.0112	-0.0103	-0.0092	-0.0088	-0.0080	-0.0073	-0.0060	-0.0043	-0.0038	-0.0026	-0.0027	-0.004159501	-0.004237969	-0.002988716	-0.000190107	0];
c_g1JP	= [-0.0104	-0.0103	-0.0102	-0.0110	-0.0122	-0.0129	-0.0137	-0.0135	-0.0129	-0.0123	-0.0119	-0.0114	-0.0113	-0.0111	-0.0100	-0.0087	-0.0066	-0.0055	-0.0054	-0.0059	-0.005391934	-0.004279628	-0.003078086	-0.001181014	-0.000392811];
c_g1oth	= [-0.0087	-0.0088	-0.0092	-0.0108	-0.0126	-0.0130	-0.0123	-0.0117	-0.0107	-0.0096	-0.0092	-0.0088	-0.0084	-0.0083	-0.0069	-0.0057	-0.0044	-0.0025	-0.0029	-0.0030	-0.004391236	-0.005116295	-0.003426525	-0.003429475	-0.003810787];

phi1GLB = [-0.3222	-0.3221	-0.3296	-0.3531	-0.3684	-0.3691	-0.3718	-0.3612	-0.3614	-0.3771	-0.3810	-0.3586	-0.3360	-0.3026	-0.2284	-0.2210	-0.2975	-0.3895	-0.4850	-0.5431	-0.6079	-0.6209	-0.5489	-0.3436	-0.2978];
%%
Dc_g1as = [-0.00041	-0.00041	-0.00042	-0.00047	-0.00055	-0.00063	-0.00059	-0.00055	-0.00048	-0.00037	-0.00036	-0.00027	-0.00016	-0.00013	-1.00E-04	-0.00013	-0.00023	-0.00018	-2.00E-05	0	-0.00061	-0.00107	-0.00127	-0.00186	-0.00251];
%%
phi2tw = [-0.1093	-0.1093	-0.0780	-0.0474	-0.0323	-0.0365	-0.0993	-0.1778	-0.2283	-0.2747	-0.2877	-0.2869	-0.2527	-0.2029	-0.1145	-0.0635	-0.0335	-0.0331	-0.0172	-0.0021	0.0000	0.0000	0.0000	0.0000	0.0000];
phi3tw	= [-0.0064	-0.0064	-0.0068	-0.0065	-0.0062	-0.0059	-0.0055	-0.0055	-0.0055	-0.0056	-0.0057	-0.0057	-0.0057	-0.0057	-0.0060	-0.0064	-0.0075	-0.0079	-0.0069	-0.0052	-0.0027	-0.0015	-0.0014	-0.0014	-0.0014];

phi2 = [-0.04401	-0.04842	-0.04725	-0.02295	-0.00918	-0.00729	-0.02871	-0.05895	-0.08046	-0.10575	-0.11835	-0.13221	-0.1458	-0.15174	-0.15147	-0.14355	-0.11457	-0.0864	-0.04581	-0.02259	-0.00351	0	0	0	0];
phi3 = [-0.00549	-0.00567	-0.00621	-0.00684	-0.00243	-0.00189	-0.00216	-0.00486	-0.00387	-0.00495	-0.00576	-0.00441	-0.0045	-0.00612	-0.00648	-0.00675	-0.00693	-0.00846	-0.00774	-0.00522	-0.00081	-0.00045	-0.00099	-0.00135	-0.00162];

phi4	= [0.102151	0.102151	0.108360	0.119888	0.133641	0.148927	0.190596	0.230662	0.253169	0.266468	0.265060	0.255253	0.231541	0.207277	0.165464	0.133828	0.085153	0.058595	0.031787	0.019716	0.009643	0.005379	0.003223	0.001134	0.000515];                                                                                                                      
phi5	= [0.1202	0.1204	0.1310	0.1567	0.1935	0.2065	0.2239	0.1802	0.1425	0.1287	0.1021	0.0691	0.0237	-0.0070	-0.0164	-0.0149	-0.0014	0.0157	0.0764	0.0956	0.1307	0.1261	0.1319	0.0599	0.0350];
%%
tau =  [0.3893	0.3920	0.4105	0.4653	0.4906	0.4978	0.4723	0.4425	0.4045	0.3993	0.3886	0.3552	0.3366	0.3390	0.3635	0.3992	0.4304	0.4560	0.4655	0.4648	0.5090	0.5391	0.5308	0.5243	0.5675];
phi = [0.5139	0.5107	0.5228	0.5585	0.5917	0.6074	0.6059	0.5790	0.5652	0.5502	0.5436	0.5413	0.5379	0.5405	0.5344	0.5376	0.5512	0.5610	0.5726	0.5894	0.6060	0.6281	0.6232	0.5551	0.5141];

phiSS = [0.4032	0.4006	0.4083	0.4327	0.4426	0.4395	0.4233	0.4112	0.4103	0.4121	0.4092	0.4117	0.4136	0.4182	0.4238	0.4346	0.4426	0.4490	0.4585	0.4703	0.4806	0.4872	0.4733	0.4165	0.3832];
phiS2S = [0.3278	0.3251	0.3335	0.3663	0.3955	0.4216	0.4292	0.4098	0.3898	0.3676	0.3614	0.3572	0.3519	0.3489	0.3340	0.3254	0.3237	0.3250	0.3352	0.3540	0.3786	0.3962	0.4020	0.3446	0.2919];
%%
c1 = [-1.9398	-1.8995	-1.8096	-1.5329	-1.2582	-1.0827	-0.9155	-0.8961	-0.9558	-1.0802	-1.1501	-1.2279	-1.2958	-1.3417	-1.4460	-1.6043	-2.0807	-2.4494	-2.8588	-3.0706	-3.4409	-3.5295	-3.4555	-3.7196	-3.9452];
phi1TW = [-0.4148	-0.4084	-0.3851	-0.3781	-0.3847	-0.3772	-0.4066	-0.4112	-0.4154	-0.4476	-0.4607	-0.4526	-0.4291	-0.3699	-0.2481	-0.2107	-0.2830	-0.3970	-0.4968	-0.5302	-0.6392	-0.6944	-0.6553	-0.4744	-0.4063];
phi2tw	= [-0.1257	-0.1151	-0.0827	-0.0601	-0.0664	-0.0556	-0.0827	-0.1347	-0.1979	-0.2542	-0.2806	-0.3150	-0.2958	-0.2743	-0.1801	-0.1485	-0.1116	-0.0940	-0.0505	0.0	0.0	0.0	0.0	0.0	0.0];
phi4	= [0.102151	0.102151	0.108360	0.119888	0.133641	0.148927	0.190596	0.230662	0.253169	0.266468	0.265060	0.255253	0.231541	0.207277	0.165464	0.133828	0.085153	0.058595	0.031787	0.019716	0.009643	0.005379	0.003223	0.001134	0.000515];                                                                                                                      
%%
if rgn==1
   c_g1 = c_g1(ip) + (flg_AS~=0)*Dc_g1as(ip);
   phi1 = phi1TW(ip);
   phi2 = phi2tw(ip);
   phi3 = phi3tw(ip);
elseif rgn==2
   c_g1 = c_g1CA(ip);   
   phi1 = phi1GLB(ip); 
   phi2 = phi2(ip);
   phi3 = phi3(ip);
elseif rgn==4
   c_g1 = c_g1JP(ip); 
   phi1 = phi1GLB(ip);
   phi2 = phi2(ip);
   phi3 = phi3(ip);
else
   c_g1 = c_g1oth(ip);
   phi1 = phi1GLB(ip);
   phi2 = phi2(ip);
   phi3 = phi3(ip);
end    
%% fSOF
term2 =(c1_a(ip) + c1_c(ip)/(cosh(2*max(M-4.5,0))))*F_RV;
term3 =(c1_b(ip) + c1_d(ip)/cosh(2*max(M-4.5,0)))*F_NM;   
%% Ztor term
if F_RV==1
   E_Ztor = (max(3.5384-2.60*max(M-5.8530,0),0)).^2;
else
   E_Ztor = (max(2.7482-1.7639*max(M-5.5210,0),0)).^2;
end 
       
if Ztor == 999
   Ztor = E_Ztor;
   delta_ZTOR = 0;
else
   delta_ZTOR = Ztor - E_Ztor;
end
term4 = (c7(ip) + c7_b(ip)/cosh(2*max(M-4.5,0)))*delta_ZTOR;
%% Dip term
term5 =(c11(ip)+ c11_b(ip)/cosh(2*max(M-4.5,0)))*(cos(delta)^2); 
%% Hanging wall term
term12 = c9(ip)*HW*cos(delta)*(c9_a(ip)+(1-c9_a(ip))*tanh(Rx/c9_b(ip)))...
         *(1-sqrt(Rjb^2+Ztor^2)/(R_RUP+1));
%% Directivity
term11 = c8(ip)*max(1-max(R_RUP-40,0)/30,0)*min(max(M-5.5,0)/0.8,1)...
          *exp(-c8_a(ip)*(M-c8_b(ip))^2)*d_DPP;
%% fmag
term6 = c2*(M-6);
term7 = (c2-c3(ip))/c_n(ip)*log(1+exp(c_n(ip)*(c_m(ip)-M)));
%% Distance Scaling and attenuation term
del_c5 = dp(ip)*max(Ztor/50-20/50,0)*(Ztor>20)*(M<7.0);   
CNS = (c5(ip)+ del_c5)*cosh(c6(ip)*max(M-c_HM(ip),0));  

term8 =  c4*log(R_RUP + CNS);
term9 =  (c4_a-c4)*log(sqrt(R_RUP^2+c_RB^2));
term10 = (c_g1+c_g2(ip)/(cosh(max(M-c_g3(ip),0))))*R_RUP;
%% main shock
ln_yrefij = c1(ip) + term2 + term3 + term4 +  term5 + term6 + term7 + term8 + term9 + term10 + term11 + term12; 
yrefij = exp(ln_yrefij);
%% Site response
term14 = phi1*min(log(Vs30/1130),0);
term15 = phi2*(exp(phi3*(min(Vs30,1130)-360))-exp(phi3*(1130-360)))*log((yrefij+phi4(ip))/phi4(ip));
%%
if Z10 == -999 
   term16 = 0; 
else
   Ez_1 = exp(-3.73/2*log((Vs30.^2+290.53^2)/(1750^2+290.53^2)));
   d_Z1 = Z10 - Ez_1;
   term16 = phi5(ip)*(1-exp(-d_Z1/300));
end  
%% median prediction
Sa = yrefij*exp(term14 + term15 + term16);
%% Variance Model
Sig_SS = sqrt(phiSS(ip)^2 + tau(ip)^2);
Sig_T = sqrt(tau(ip)^2 + phi(ip)^2);
