
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Input Variables
% M     = Moment Magnitude
% T     = Period (sec); 
%              
% Rrup   = Closest distance (km) to the ruptured plane
% Rjb   = Joyner-Boore distance (km); closest distance (km) to surface
%       projection of rupture plane
% Rx    =    Horizontal distance from top of rupture measured perpendicular 
%       to fault strike (km). See Figures a, b and c for illustation% Ztor  = Depth(km) to the top of ruptured plane
% delta = Fault dip angle (in degree)
% lamda = Rake angle      (in degree)
% region        = 1 for Taiwan
%               = 2 for California
%               = 4 for Japan
%               = 3 for others 

% Z10            = Basin depth (m); depth from the groundsurface to the
%                   1km/s shear-wave horizon.
%               = -999 if unknown
%               = 'na' if unknow
% Vs30          = shear wave velocity averaged over top 30 m in m/s
%               = ref: 1130
% Ztor          = depth to top of rupture , [km]
%               =-999 if specify average Ztor
% Output Variables
% Sa: Median spectral acceleration prediction
% sigma: logarithmic standard deviation of spectral acceleration
%          prediction based on tau and phi model of CY14 with the change in
%          phi1.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function [Sa, yrefij, sigma_T, sigma_T2] = Phung_2018c2_NGAw2_TW(M, T, Rrup, Rjb, Rx, Ztor, delta, Fhw, lambda, Vs30, Z10, rgn, flg_AS)
period = [0 0.01 0.02	0.03  0.04	0.05  0.075  0.1  0.12  0.15  0.17  0.2  0.25 0.30 0.4  0.5 ...
    0.75  1.0   1.5   2  3  4  5  7.5  10];
delta=delta*pi()/180.0;
F_RV = lambda >= 30 & lambda <= 150; % frv: 1 for lambda between 30 and 150, 0 otherwise
F_NM = lambda >= -120 & lambda <= -60; % fnm: 1 for lambda between -120 and -60, 0 otherwise

if Fhw == 1
    HW = 1;
elseif Fhw == 0
    HW = 0;
else
    HW = Rx>=0;
end
d_DPP=0; % for median calculatio, d_DPP=0.
%% 
if length (T) == 1 && T == 1000 % Compute Sa and sigma with pre-defined period
    Sa=zeros(1,length(period));
    yrefij=zeros(1,length(period));

    sigma_T = zeros(1, length(T));
     sigma_T2 = zeros(1, length(T));
    for ip=1:length(period)
        [Sa(ip),yrefij(ip),sigma_T(ip),sigma_T2(ip)]=Phung_2018_sub(M, ip, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
    end
else                            % Compute Sa and sigma with user-defined period
    Sa=zeros(1, length(T));
    yrefij = zeros(1, length(T));
    sigma_T = zeros(1, length(T));
     sigma_T2 = zeros(1, length(T));
    for i=1:length(T)
        Ti = T(i);
        if ( isempty(find(abs(period-Ti) < 0.0001))) % The user defined period requires interpolation
            T_low = max(period(period < Ti));
            T_high = min(period(period > Ti));
            ip_low  = find(period==T_low);
            ip_high = find(period==T_high);
            
            [Sa_low,yrefij_low,sig_low,sig_low2] = Phung_2018_sub(M, ip_low, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
            
            [Sa_high,yrefij_high,sig_high,sig_high2] = Phung_2018_sub(M, ip_high, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
           
            x = [log(T_low) log(T_high)];
            Y_sa = [log(Sa_low) log(Sa_high)];
            Y_yrefij = [yrefij_low yrefij_high];
            Y_sig = [sig_low sig_high];
             Y_sig2 = [sig_low2 sig_high2];
            
            Sa(i) = exp(interp1(x, Y_sa, log(Ti)));
            yrefij(i) = exp(interp1(x, Y_yrefij, log(T(i))));
            sigma_T(i) = interp1(x, Y_sig, log(T(i)));
            sigma_T2(i) = interp1(x, Y_sig2, log(T(i)));
        else
            ip_T = find(abs((period- Ti)) < 0.0001);
            [Sa(i),yrefij(i), sigma_T(i),sigma_T2(i)] = Phung_2018_sub(M, ip_T, Rrup, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS);
        end
    end
end


function [Sa, yrefij,Sig_SS,Sig_T] = Phung_2018_sub(M, ip, R_RUP, Rjb, Rx, Ztor, delta, HW, F_RV, F_NM, Vs30, Z10, rgn, d_DPP, flg_AS)
%% period-indipendent fixing coefs
c4 = -2.1;
c4_a = -0.5;
c_RB = 50;
c2 = 1.06; 
%%
c1 = [-1.4526	-1.4468	-1.4066	-1.3175	-1.1970	-1.0642	-0.7737	-0.5958	-0.5229	-0.5005	-0.5165	-0.5558	-0.6550	-0.7898	-1.0839	-1.3279	-1.9346	-2.3932	-2.9412	-3.2794	-3.5891	-3.8483	-3.9458	-4.2514	-4.5075];
c3 = [1.4379	1.4379	1.4030	1.3628	1.3168	1.2552	1.1873	1.2485	1.3263	1.4098	1.4504	1.5274	1.6737	1.8298	2.0330	2.2044	2.4664	2.6194	2.7708	2.8699	2.9293	3.0012	3.0012	3.0012	3.0012];
c_n = [12.14866822	12.14866822	12.24803407	12.53378414	12.99189704	13.65075358	15.71447541	16.77262242	16.77563032	16.18679785	15.84314399	15.01467129	12.69643148	10.44981091	6.802216656	4.41069375	3.4064	3.1612	2.8078	2.4631	2.2111	1.9668	1.6671	1.5737	1.5265];
c_m = [5.50455	5.51303	5.51745	5.51798	5.51462	5.50692	5.43078	5.42081	5.46158	5.55373	5.60449	5.64383	5.66058	5.65301	5.62843	5.59326	5.56641	5.60836	5.73551	5.85199	6.08195	6.25683	6.39882	6.66908	6.84353];
%%
c_g2	= [-0.007127092	-0.007127092	-0.007248737	-0.007327856	-0.007361759	-0.007360913	-0.007051574	-0.005719182	-0.00436511	-0.002649555	-0.001999512	-0.001254506	-0.00075041	-0.000447155	-0.000247246	-0.000416797	-0.001131462	-0.001741492	-0.002427965	-0.002705545	-0.004107346	-0.005776395	-0.007747849	-0.009141588	-0.012633296];
c_g3	= [4.225634814	4.225634814	4.230341898	4.236182109	4.250188668	4.303122568	4.446126947	4.610835161	4.723496543	4.878140618	4.981707053	5.066410859	5.21986472	5.32821979	5.201761713	5.187931728	4.877209058	4.63975087	4.571203643	4.425116502	3.6219035	3.48626393	3.277906342	3.074948086	3.074948086];
%% Fixed Coefficients    
c5	= [6.4551	6.4551	6.4551	6.4551	6.4551	6.4551	6.4551	6.8305	7.1333	7.3621	7.4365	7.4972	7.5416	7.5600	7.5735	7.5778	7.5808	7.5814	7.5817	7.5818	7.5818	7.5818	7.5818	7.5818	7.5818];
c_HM = [3.0956	3.0956	3.0963	3.0974	3.0988	3.1011	3.1094	3.2381	3.3407	3.4300	3.4688	3.5146	3.5746	3.6232	3.6945	3.7401	3.7941	3.8144	3.8284	3.8330	3.8361	3.8369	3.8376	3.8380	3.8380];
c6	= [	0.4908	0.4908	0.4925	0.4992	0.5037	0.5048	0.5048	0.5048	0.5048	0.5045	0.5036	0.5016	0.4971	0.4919	0.4807	0.4707	0.4575	0.4522	0.4501	0.4500	0.4500	0.4500	0.4500	0.4500	0.4500];
dp	= [-6.785205271	-6.750647967	-6.716179208	-6.681798923	-6.647507037	-6.613303475	-6.52818049	-6.443607867	-6.376345237	-6.276109027	-6.209722535	-6.110797854	-5.947665543	-5.786703295	-5.47125339	-5.164376146	-4.4342041	-3.75596604	-2.55026692	-1.536847647	-0.052837841	0	0	0	0];
phi2	= [-0.1417	-0.1417	-0.1364	-0.1403	-0.1591	-0.1862	-0.2538	-0.2943	-0.3077	-0.3113	-0.3062	-0.2927	-0.2662	-0.2405	-0.1975	-0.1633	-0.1028	-0.0699	-0.0425	-0.0302	-0.0129	-0.0016	0.0000	0.0000	0.0000];
phi3	= [-0.007010 -0.007010	-0.007279	-0.007354	-0.006977	-0.006467	-0.005734	-0.005604	-0.005696	-0.005845	-0.005959	-0.006141	-0.006439	-0.006704	-0.007125	-0.007435	-0.008120	-0.008444	-0.007707	-0.004792	-0.001828	-0.001523	-0.001440	-0.001369	-0.001361];
phi4	= [0.102151	0.102151	0.108360	0.119888	0.133641	0.148927	0.190596	0.230662	0.253169	0.266468	0.265060	0.255253	0.231541	0.207277	0.165464	0.133828	0.085153	0.058595	0.031787	0.019716	0.009643	0.005379	0.003223	0.001134	0.000515];                                                                                                                      
%%
c7	= [0.00803536	0.00803536	0.007592927	0.007250488	0.007006048	0.006860143	0.007007726	0.007246641	0.007455965	0.00770271	0.007798775	0.007823121	0.00807121	0.008395901	0.00927498	0.010165826	0.012793392	0.013761922	0.013899933	0.012559337	0.009183764	0.004796976	0.001067909	-0.004234005	-0.006203311];
c7_b	= [0.021034339	0.021034339	0.021638743	0.022052403	0.022283866	0.022340988	0.021712418	0.020031223	0.018584674	0.016544376	0.015412673	0.014410752	0.013237789	0.011957864	0.00946882	0.005799966	-0.003683309	-0.008131001	-0.010287269	-0.008563294	-0.003058727	0.003919649	0.013063958	0.027920315	0.04195315];
%%
c1_a	= [0.137929376	0.131008944	0.124713602	0.119040284	0.113983621	0.109535952	0.101016047	0.096066418	0.094563811	0.096331606	0.100411816	0.113754448	0.132878713	0.147312358	0.158162078	0.163112167	0.169389333	0.177254643	0.17612706	0.161185738	0.112720638	0.053953075	0.053953075	0.053953075	0.053953075];
c1_c	= [0.04272907	0.05491546	0.06599634	0.075907583	0.08465752	0.092384148	0.109529939	0.11002146	0.101539072	0.081268087	0.066332395	0.047001724	0.018708157	 0	0	0	0	0	0	0	0	0	0	0	0];

c1_b = [0	0	0	0	0	0	0	0	0	0	0	0	-0.034932397	-0.052793111	-0.096705093	-0.121161057	-0.158672494	-0.184203622	-0.218917854	-0.218956446	-0.218956446	-0.218956446	-0.218956446	-0.218956446	-0.218956446];
c1_d = [-0.165254064	-0.164615502	-0.166706035	-0.19413385	-0.2133523	-0.246430796	-0.240863766	-0.22991286	-0.171017133	-0.13673324	-0.085084587	-0.078934463	-2.86E-07	0	0	0	0	0	0	0	0	0	0	0	0];

c11	= [-0.108037007	-0.108037007	-0.102071888	-0.104638092	-0.105159212	-0.09694663	-0.079174009	-0.120806584	-0.127655488	-0.123958373	-0.120234904	-0.128554524	-0.104990465	-0.125335213	-0.131458922	-0.102606613	-0.072842909	-0.072286657	-0.143270261	-0.171095562	-0.269171794	-0.321537372	-0.344321787	-0.379466889	-0.478010668];
c11_b = [0.195951708	0.195951708	0.181778172	0.163170085	0.142063237	0.098053885	0.046296818	0.173997245	0.209294889	0.217339629	0.218818569	0.262936287	0.231024464	0.27034386	0.306056087	0.272617073	0.265158493	0.303895403	0.443286099	0.520454201	0.817526599	1.015932218	0.892205391	0.86436398	1.443597529];
%%
c9	= [0.9228	0.9228	0.9296	0.9396	0.9661	0.9794	1.0260	1.0177	1.0008	0.9801	0.9652	0.9459	0.9196	0.8829	0.8302	0.7884	0.6754	0.6196	0.5101	0.3917	0.1244	0.0086	0.0000	0.0000	0.0000];
c9_a	= [0.1202	0.1202	0.1217	0.1194	0.1166	0.1176	0.1171	0.1146	0.1128	0.1106	0.1150	0.1208	0.1208	0.1175	0.1060	0.1061	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000	0.1000];
c9_b	= [6.8607	6.8607	6.8697	6.9113	7.0271	7.0959	7.3298	7.2588	7.2372	7.2109	7.2491	7.2988	7.3691	6.8789	6.5334	6.5260	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000	6.5000];

c8	= [0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0991	0.1982	0.2154	0.2154	0.2154	0.2154	0.2154	0.2154	0.2154	0.2154];
c8_a	= [0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695	0.2695];
c8_b	= [0.4833	0.4833	1.2144	1.6421	1.9456	2.1810	2.6087	2.9122	3.1045	3.3399	3.4719	3.6434	3.8787	4.0711	4.3745	4.6099	5.0376	5.3411	5.7688	6.0723	6.5000	6.8035	7.0389	7.4666	7.7700];
%%
% c12 = [-1.282688908	-1.282688908	-1.219189069	-1.129842391	-1.009367871	-0.864733627	-0.543806592	-0.372706269	-0.361923917	-0.406746707	-0.430596429	-0.517179185	-0.683634944	-0.858818908	-1.167698273	-1.414494521	-1.915634927	-2.405746274	-3.076775856	-3.344039931	-3.621193267	-3.870076534	-3.941815776	-4.193292591	-4.33514388];
% c12_b = [0.029231406	0.029231406	0.029463211	0.029897695	0.030887621	0.03256833	0.034602039	0.035821539	0.028768271	0.025510321	0.026722101	0.024730499	0.01982955	0.018366075	0.015383491	0.015996408	0.020897161	0.013663365	0.012057836	0.009195969	0.006748877	0.004630924	0	0	0];
%%
c_g1TW	= [-0.0087980	-0.0087980	-0.0090670	-0.0094510	-0.0098320	-0.0101940	-0.0109620	-0.0114520	-0.0115970	-0.0115790	-0.0113030	-0.0108190	-0.0100190	-0.0092670	-0.0079030	-0.0069990	-0.0054380	-0.0045400	-0.0036370	-0.0029726	-0.0024872	-0.0021234	-0.0017638	-0.0010788	-0.0007423];
phi1TW	= [-0.510745033	-0.510415026	-0.502941955	-0.491366306	-0.474484696	-0.459984157	-0.446396645	-0.476282069	-0.4931516	-0.517925624	-0.532965478	-0.547665313	-0.565549294	-0.606451856	-0.653316566	-0.674933921	-0.796961941	-0.884871551	-0.958271065	-0.968084348	-0.96759396	-0.964753341	-0.923270348	-0.85471647	-0.770092758];
Dc_g1as = [-0.00148591	-0.001553994	-0.001332937	-0.001500854	-0.001727377	-0.002042414	-0.002375719	-0.002929177	-0.002868694	-0.002692777	-0.002436738	-0.002502554	-0.002342412	-0.002040929	-0.001429428	-0.001044295	0	0	0	0	0	0	0	0	0];

c_g1CA	= [-0.006937324	-0.006982409	-0.007105962	-0.007654162	-0.008235534	-0.008985334	-0.010178327	-0.010859197	-0.010797857	-0.010419656	-0.009960427	-0.009509403	-0.008707306	-0.007614433	-0.0063373	-0.005515638	-0.003324985	-0.002895489	-0.001749137	-0.001160868	-0.001243607	-0.001243607	-0.001243607	-0.001243607	-0.001243607];
phi1CA	= [-0.484221897	-0.481325676	-0.473436602	-0.460829876	-0.442342385	-0.404306111	-0.385991895	-0.431169291	-0.449168755	-0.468824982	-0.497020598	-0.524364877	-0.573301197	-0.60870418	-0.672656694	-0.733923523	-0.844223441	-0.932541432	-0.98261014	-0.95905628	-0.913057084	-0.933614579	-0.852999852	-0.731675782	-0.555405551];

c_g1JP	= [-0.009554995	-0.009621694	-0.009678565	-0.010021137	-0.010348898	-0.010606375	-0.010285208	-0.010753951	-0.01131987	-0.011809781	-0.011945969	-0.012104115	-0.012011131	-0.011583213	-0.010377611	-0.009392201	-0.007154876	-0.005643852	-0.004814825	-0.005047271	-0.004730659	-0.003087049	-0.001983904	0.000347579	0.001144285];
phi1JP	= [-0.535583503	-0.527374167	-0.509697529	-0.481412435	-0.433457113	-0.35987791	-0.227565057	-0.279289236	-0.348471281	-0.440922758	-0.509266123	-0.595400115	-0.708979498	-0.792224081	-0.867597085	-0.922617109	-1.024238579	-1.052091854	-1.088340342	-1.086834766	-1.017732708	-0.910235842	-8.01E-01	-5.47E-01	-0.464975616];

c_g1GLB	= [-0.008207338	-0.008266685	-0.008372404	-0.008893062	-0.009471857	-0.009965209	-0.010848089	-0.01136162	-0.011514176	-0.011431783	-0.01109686	-0.010650653	-0.009707027	-0.008888726	-0.007382039	-0.006165716	-0.004216545	-0.003321554	-0.002382593	-0.002166838	-0.002207237	-0.001854414	-0.001525789	-0.001034361	-0.000207365];  
phi1GLB	= [-0.505350491	-0.504993164	-0.497396753	-0.484084547	-0.464454841	-0.441619243	-0.418370706	-0.448999162	-0.469073942	-0.499329355	-0.521025765	-0.542326413	-0.570861885	-0.616028974	-0.667318538	-0.693380936	-0.814440958	-0.896887535	-0.966713194	-0.973218415	-0.965187761	-0.956076432	-0.90692656	-0.806827389	-0.710919477];
%%
phi5TW	= [0.07436	0.07436	0.07359	0.07713	0.08249	0.09010	0.10291	0.12596	0.11942	0.10019	0.08862	0.08048	0.08000	0.08013	0.07916	0.07543	0.07573	0.07941	0.12820	0.16687	0.20292	0.17899	0.17368	0.15176	0.14062];
phi6TW	= [300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300	300];
phi5CA	= [0.032134169	0.031948851	0.032083196	0.031462124	0.034324999	0.031188831	0.022101594	0.030782851	0.039955704	0.029374116	0.038181875	0.048572809	0.052015826	0.046520626	0.087073138	0.090202859	0.068955592	9.01E-02	0.131818315	0.171872332	0.152581614	0.187006538	0.206446726	0.264763991	0.228563922];
phi5JP	= [0.092181936	0.091289209	0.087461387	0.085075638	0.078902251	0.068543862	0.031193656	0.087905262	0.135335734	0.134933456	0.177785878	0.147248099	0.122156442	0.063742847	0.182053316	0.179683104	0.355638284	0.446281385	0.718324249	0.767882913	0.92637631	0.881214487	0.891977077	0.83242751	0.689143919];
phi6JP	= [800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800	800];
%%
tau = [0.372991982	0.372455184	0.37404339	0.386799496	0.400724323	0.415407087	0.425118035	0.416469357	0.402380557	0.382176649	0.371903621	0.357414054	0.337728984	0.359262599	0.397614543	0.426900573	0.466977537	0.495441465	0.487074394	0.477953808	0.436531699	0.449129802	0.46456534	0.505675779	0.448423418];

phi_SS = [0.4397	0.4388	0.4391	0.4451	0.4516	0.4555	0.4558	0.4497	0.4429	0.4382	0.4385	0.4395	0.4433	0.4498	0.4590	0.4703	0.4707	0.4643	0.4568	0.4521	0.4524	0.4461	0.4420	0.4177	0.3926];
phi_S2S = [0.3149	0.3149	0.3148	0.3223	0.3347	0.3514	0.3845	0.3935	0.3897	0.3713	0.3632	0.3503	0.3343	0.3324	0.3299	0.3319	0.3384	0.3480	0.3697	0.3826	0.3974	0.3983	0.3985	0.3878	0.3717];

sig_SS = [0.5766	0.5756	0.5768	0.5897	0.6038	0.6165	0.6233	0.6129	0.5984	0.5814	0.5750	0.5665	0.5573	0.5757	0.6073	0.6352	0.6630	0.6790	0.6678	0.6579	0.6287	0.6330	0.6412	0.6559	0.5960];
sig_TOT = [0.672899987	0.671374421	0.672061617	0.687372811	0.706122677	0.725510488	0.748191261	0.744953743	0.730667128	0.706545583	0.696399878	0.682643889	0.666628056	0.6810879	0.707107965	0.732357336	0.758959277	0.776876787	0.778458113	0.774272629	0.742033865	0.747199151	0.755236371	0.769755177	0.728570986];
%%
if rgn==1
   c_g1 = c_g1TW(ip) + (flg_AS~=0)*Dc_g1as(ip);
   phi1 = phi1TW(ip);
elseif rgn==2
   c_g1 = c_g1CA(ip);   
   phi1 = phi1CA(ip);
elseif rgn==4
   c_g1 = c_g1JP(ip); 
   phi1 = phi1JP(ip);
else
   c_g1 = c_g1GLB(ip);
   phi1 = phi1GLB(ip);
end    
%% fSOF
term2=(c1_a(ip) + c1_c(ip)/(cosh(2*max(M-4.5,0))))*F_RV;
term3=(c1_b(ip) + c1_d(ip)/cosh(2*max(M-4.5,0)))*F_NM;   
%% Ztor term
if F_RV==1
   E_Ztor = (max(3.5384-2.60*max(M-5.8530,0),0)).^2;
else
   E_Ztor = (max(2.7482-1.7639*max(M-5.5210,0),0)).^2;
end 
       
if Ztor == 999
   Ztor = E_Ztor;
   delta_ZTOR = 0;
else
   delta_ZTOR = Ztor - E_Ztor;
end
term4 = (c7(ip)+c7_b(ip)/cosh(2*max(M-4.5,0)))*delta_ZTOR;
%% Dip term
term5 =(c11(ip)+ c11_b(ip)/cosh(2*max(M-4.5,0)))*(cos(delta)^2); 
%% Hanging wall term
term12 = c9(ip)*HW*cos(delta)*(c9_a(ip)+(1-c9_a(ip))*tanh(Rx/c9_b(ip)))...
    *(1-sqrt(Rjb^2+Ztor^2)/(R_RUP+1));
%% Directivity
term11 = c8(ip)*max(1-max(R_RUP-40,0)/30,0)*min(max(M-5.5,0)/0.8,1)...
          *exp(-c8_a(ip)*(M-c8_b(ip))^2)*d_DPP;
%% fmag
term6 = c2*(M-6);
term7 = (c2-c3(ip))/c_n(ip)*log(1+exp(c_n(ip)*(c_m(ip)-M)));
%% Distance Scaling and attenuation term
del_c5 = dp(ip)*max(Ztor/50-20/50,0)*(Ztor>20)*(M<7.0);   
CNS = (c5(ip)+ del_c5)*cosh(c6(ip)*max(M-c_HM(ip),0));  

term8 =  c4*log(R_RUP + CNS);
term9 =  (c4_a-c4)*log(sqrt(R_RUP^2+c_RB^2));
term10 = (c_g1 + c_g2(ip)/(cosh(max(M-c_g3(ip),0))))*R_RUP;
%% main shock
   term1 = c1(ip);
   ln_yrefij = term1 + term2 + term3 + term4 +  term5 + term6 + term7 + term8 + term9 + term10 + term11 + term12; 
yrefij = exp(ln_yrefij);
%% Site response
term14 = phi1*min(log(Vs30/1130),0);
term15 = phi2(ip)*(exp(phi3(ip)*(min(Vs30,1130)-360))-exp(phi3(ip)*(1130-360)))*log((yrefij+phi4(ip))/phi4(ip));
%% Basin Depth
if rgn == 1
    Ez_1 = exp(-3.73/2*log((Vs30.^2+290.53^2)/(1750^2+290.53^2)));
    phi5 = phi5TW(ip);
    phi6TW = phi6TW(ip);
elseif rgn ==2
    Ez_1 = exp(-5.23/2*log((Vs30^2+412.39^2)/(1360^2+412.39^2)));
    phi5 = phi5CA(ip);
    phi6TW = phi6TW(ip);
elseif rgn==4
    Ez_1= exp(-5.23/2*log((Vs30^2+412.39^2)/(1360^2+412.39^2)));
    phi5 = phi5JP(ip);
    phi6TW = phi6JP(ip);
else
    Z10 = -999;
end

if Z10 == -999 
   term16 = 0; 
else
   d_Z1 = Z10 - Ez_1;
   term16 = phi5*(1-exp(-d_Z1/300));
end    
%% median prediction
Sa = yrefij*exp(term14 + term15 + term16);
%% Variance Model-2 for Taiwan
Sig_SS = sqrt(phi_SS(ip)^2 + phi_S2S(ip)^2);
Sig_T = sqrt(tau(ip)^2 + phi_SS(ip)^2 + phi_S2S(ip)^2);
